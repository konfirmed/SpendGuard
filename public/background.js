(()=>{"use strict";const e="purchases",t="totalIntercepts";async function s(e){return(await chrome.storage.local.get(e))[e]}async function n(e,t){await chrome.storage.local.set({[e]:t})}chrome.runtime.onInstalled.addListener((async()=>{console.log("SpendGuard installed â€“ initializing storage"),await n(e,[]),await n(t,0),await n("settings",{cooldownSeconds:30,enableNudges:!0,enableScamDetection:!0})})),chrome.runtime.onMessage.addListener(((a,c,i)=>((async()=>{if("incrementIntercepts"===a.action){const e=(await s(t)||0)+1;await n(t,e),i({success:!0,newCount:e})}if("addPurchase"===a.action){const t=await s(e)||[];t.unshift({...a.purchase,id:Date.now().toString()}),t.length>100&&t.splice(100),await n(e,t),i({success:!0})}if("getSettings"===a.action){const e=await s("settings")||{cooldownSeconds:30,enableNudges:!0,enableScamDetection:!0,categoryBudgets:{Electronics:500,Clothing:300,Books:100,Home:400,Other:200}};i({success:!0,settings:e})}if("getRecentPurchases"===a.action){const t=await s(e)||[];i({success:!0,purchases:t})}if("updateSettings"===a.action&&(await n("settings",a.settings),i({success:!0})),"getSpendingInsights"===a.action){const n=await s(e)||[],a=await s(t)||0,c=Date.now()-6048e5,o=n.filter((e=>e.intercepted&&e.timestamp>c)).length,r=n.filter((e=>e.proceeded)).reduce(((e,t)=>e+(t.amount||0)),0),d=n.filter((e=>e.intercepted&&!e.proceeded)).reduce(((e,t)=>e+(t.amount||50)),0);i({success:!0,insights:{totalIntercepts:a,thisWeekIntercepts:o,totalSpent:r,estimatedSavings:d,recentPurchases:n.slice(0,10)}})}})().catch((e=>{console.error("SpendGuard background error:",e),i({success:!1,error:e.message})})),!0)))})();